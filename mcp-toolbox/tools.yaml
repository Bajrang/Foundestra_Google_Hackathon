sources:
  my-cloud-sql-source:
    kind: cloud-sql-postgres
    project: foundestra
    region: us-central1
    instance: hoteldb-instance
    database: postgres
    user: postgres
    password: "postgres"

  # Source used to store credentials for micro-apps (same Cloud SQL instance)
  credentials-db:
    kind: cloud-sql-postgres
    project: foundestra
    region: us-central1
    instance: hoteldb-instance
    database: postgres
    user: postgres
    password: "postgres"

tools:
  search-hotels-by-name:
    kind: postgres-sql
    source: my-cloud-sql-source
    description: Search for hotels based on name.
    parameters:
      - name: name
        type: string
        description: The name of the hotel.
    statement: SELECT * FROM hotels WHERE name ILIKE '%' || $1 || '%';
  search-hotels-by-location:
    kind: postgres-sql
    source: my-cloud-sql-source
    description: Search for hotels based on location.  Result is sorted by price from least to most expensive.
    parameters:
      - name: location
        type: string
        description: The location of the hotel.
    statement: |
      SELECT *
      FROM hotels
      WHERE location ILIKE '%' || $1 || '%'
      ORDER BY
        CASE price_tier
          WHEN 'Midscale' THEN 1
          WHEN 'Upper Midscale' THEN 2
          WHEN 'Upscale' THEN 3
          WHEN 'Upper Upscale' THEN 4
          WHEN 'Luxury' THEN 5
          ELSE 99 -- Handle any unexpected values, place them at the end
        END;

    # Credential management tools (store credentials JSON per app)
    create-credential:
      kind: postgres-sql
      source: credentials-db
      description: Insert a credentials JSON blob for an app_name
      parameters:
        - name: app_name
          type: string
        - name: credentials_json
          type: string
      statement: |
        INSERT INTO credentials (app_name, credentials_json)
        VALUES ($1, $2)
        RETURNING id, created_at;

    get-latest-credential:
      kind: postgres-sql
      source: credentials-db
      description: Return the latest credential JSON for an app
      parameters:
        - name: app_name
          type: string
      statement: |
        SELECT credentials_json
        FROM credentials
        WHERE app_name = $1
        ORDER BY created_at DESC
        LIMIT 1;

    # HTTP wrappers for three micro-apps (replace URLs with real endpoints)
    call-itinerary-generator:
      kind: http
      description: Call the itinerary generator microservice (POST /generate)
      url: "http://itinerary-generator:3000/generate"
      method: POST
      headers:
        Content-Type: application/json

    call-activities-service:
      kind: http
      description: Call the activities microservice (POST /recommend)
      url: "http://activities-service:3000/recommend"
      method: POST
      headers:
        Content-Type: application/json

    call-places-service:
      kind: http
      description: Call the places microservice (GET /places?query=...)
      url: "http://places-service:3000/places"
      method: GET
      headers:
        Accept: application/json

toolsets:
   my_first_toolset:
     - search-hotels-by-name
     - search-hotels-by-location

   multi_app_toolset:
     - call-itinerary-generator
     - call-activities-service
     - call-places-service
     - create-credential
     - get-latest-credential

