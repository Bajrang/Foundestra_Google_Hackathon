# ğŸ”§ Environment Variables Configuration

## ğŸ“‹ Required Environment Variables in Supabase

All these variables should be set in: **Supabase Dashboard â†’ Edge Functions â†’ Settings â†’ Secrets**

---

## ğŸ” Primary Variables (OAuth2 with Service Account)

### 1. **GOOGLE_SERVICE_ACCOUNT_KEY** â­ Required for Production

**Type:** JSON Object (as string)  
**Source:** Generated by `./setup-vertex-oauth.sh` or Google Cloud Console  
**Purpose:** OAuth2 authentication with Vertex AI

**Value Format:**
```json
{
  "type": "service_account",
  "project_id": "foundestra",
  "private_key_id": "abc123...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...",
  "client_email": "google-hackathon-sa@foundestra.iam.gserviceaccount.com",
  "client_id": "123456789...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/..."
}
```

**How to Get:**
```bash
# Option 1: Run automated script (recommended)
./setup-vertex-oauth.sh

# Option 2: Manual
gcloud iam service-accounts keys create google-hackathon-sa-key.json \
    --iam-account=google-hackathon-sa@foundestra.iam.gserviceaccount.com

# Then copy the entire JSON content
cat google-hackathon-sa-key.json
```

**Priority:** ğŸ”´ CRITICAL - Without this, OAuth2 auth will not work

---

### 2. **GOOGLE_CLOUD_PROJECT** or **PROJECT_ID**

**Type:** String  
**Value:** `foundestra`  
**Purpose:** Google Cloud project ID

**Either name works - the code checks for both:**
- `GOOGLE_CLOUD_PROJECT` (Google Cloud standard)
- `PROJECT_ID` (shorter alternative)

**How to Set:**
```
Variable Name: GOOGLE_CLOUD_PROJECT
Value: foundestra
```
OR
```
Variable Name: PROJECT_ID
Value: foundestra
```

**Priority:** ğŸŸ¡ RECOMMENDED - Falls back to default if not set

---

### 3. **SERVICE_ACCOUNT_NAME**

**Type:** String  
**Value:** `google-hackathon-sa`  
**Purpose:** Name of the service account (for logging and documentation)

**How to Set:**
```
Variable Name: SERVICE_ACCOUNT_NAME
Value: google-hackathon-sa
```

**Priority:** ğŸŸ¢ OPTIONAL - Falls back to default if not set

---

## ğŸ”‘ Fallback Variable (API Key Method)

### 4. **VERTEX_AI_API_KEY** (Development/Testing Only)

**Type:** String  
**Source:** https://aistudio.google.com/app/apikey  
**Purpose:** Simple API key authentication (Generative Language API)

**How to Get:**
1. Visit: https://aistudio.google.com/app/apikey
2. Click "Create API Key"
3. Copy the key
4. Set in Supabase

**How to Set:**
```
Variable Name: VERTEX_AI_API_KEY
Value: AIzaSy...your-api-key-here
```

**Priority:** ğŸŸ¡ FALLBACK - Used only if GOOGLE_SERVICE_ACCOUNT_KEY not set  
**Note:** âš ï¸ API key method is simpler but less secure than service account

---

## ğŸ“Š Configuration Matrix

| Variable | Type | Priority | Default | Purpose |
|----------|------|----------|---------|---------|
| `GOOGLE_SERVICE_ACCOUNT_KEY` | JSON | ğŸ”´ Critical | None | OAuth2 authentication |
| `GOOGLE_CLOUD_PROJECT` | String | ğŸŸ¡ Recommended | `foundestra` | Project ID |
| `PROJECT_ID` | String | ğŸŸ¡ Recommended | `foundestra` | Project ID (alternative) |
| `SERVICE_ACCOUNT_NAME` | String | ğŸŸ¢ Optional | `google-hackathon-sa` | SA name |
| `VERTEX_AI_API_KEY` | String | ğŸŸ¡ Fallback | None | API key auth |

---

## ğŸš€ Quick Setup Guide

### Production Setup (Recommended)

1. **Run the setup script:**
   ```bash
   ./setup-vertex-oauth.sh
   ```

2. **Copy the generated JSON output**

3. **Set in Supabase:**
   - Go to: Supabase Dashboard â†’ Edge Functions â†’ Settings â†’ Secrets
   - Add variables:
     ```
     GOOGLE_SERVICE_ACCOUNT_KEY = {paste entire JSON from step 2}
     GOOGLE_CLOUD_PROJECT = foundestra
     SERVICE_ACCOUNT_NAME = google-hackathon-sa
     ```

4. **Redeploy edge function**

5. **Test:**
   ```bash
   curl https://iloickicgibzbrxjsize.supabase.co/functions/v1/make-server-f7922768/test-vertexai
   ```

---

### Development Setup (Quick)

1. **Get API key:**
   - Visit: https://aistudio.google.com/app/apikey
   - Create API key

2. **Set in Supabase:**
   ```
   VERTEX_AI_API_KEY = your-api-key-here
   ```

3. **Test:**
   ```bash
   curl https://iloickicgibzbrxjsize.supabase.co/functions/v1/make-server-f7922768/test-vertexai
   ```

---

## ğŸ” Verify Configuration

### Check Which Variables Are Set

```bash
curl https://iloickicgibzbrxjsize.supabase.co/functions/v1/make-server-f7922768/vertex-config \
    -H "Authorization: Bearer YOUR_SUPABASE_ANON_KEY"
```

**Expected Response:**
```json
{
  "environmentVariables": {
    "GOOGLE_CLOUD_PROJECT": "âœ“ Set",
    "PROJECT_ID": "âœ“ Set",
    "SERVICE_ACCOUNT_NAME": "âœ“ Set",
    "GOOGLE_SERVICE_ACCOUNT_KEY": "âœ“ Set",
    "VERTEX_AI_API_KEY": "âœ— Not set"
  },
  "configuration": {
    "activeMethod": "OAuth2 with Service Account (production)"
  }
}
```

---

## ğŸ¯ Authentication Modes

### Mode 1: OAuth2 with Service Account (Production) âœ…

**When Active:**
- `GOOGLE_SERVICE_ACCOUNT_KEY` is set

**Advantages:**
- âœ… Production-ready
- âœ… Secure OAuth2 authentication
- âœ… Full IAM control
- âœ… Higher quotas
- âœ… Enterprise features

**Endpoint Used:**
```
https://us-central1-aiplatform.googleapis.com/v1/projects/foundestra/locations/us-central1/publishers/google/models/gemini-2.0-flash-exp:generateContent
```

**Authentication:**
```
Authorization: Bearer {oauth2_token}
```

---

### Mode 2: API Key (Development) âš ï¸

**When Active:**
- `VERTEX_AI_API_KEY` is set
- `GOOGLE_SERVICE_ACCOUNT_KEY` is NOT set

**Advantages:**
- âœ… Simple setup
- âœ… Quick to test
- âœ… Good for development

**Limitations:**
- âš ï¸ Less secure
- âš ï¸ Lower quotas
- âš ï¸ No IAM features

**Endpoint Used:**
```
https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={api_key}
```

---

### Mode 3: Disabled âŒ

**When Active:**
- Neither `GOOGLE_SERVICE_ACCOUNT_KEY` nor `VERTEX_AI_API_KEY` is set

**Behavior:**
- Uses enhanced static suggestions
- No AI features
- Fallback mode only

---

## ğŸ› ï¸ Troubleshooting

### Issue: "No AI credentials configured"

**Check:**
```bash
curl https://iloickicgibzbrxjsize.supabase.co/functions/v1/make-server-f7922768/vertex-config
```

**Solution:**
Set at least one of:
- `GOOGLE_SERVICE_ACCOUNT_KEY` (recommended)
- `VERTEX_AI_API_KEY` (fallback)

---

### Issue: "Failed to parse GOOGLE_SERVICE_ACCOUNT_KEY"

**Cause:** Invalid JSON format

**Solution:**
1. Ensure you copied the ENTIRE JSON
2. Don't add extra quotes or formatting
3. Paste exactly as generated by the script
4. JSON must start with `{` and end with `}`

**Test JSON validity:**
```bash
# Save to file
cat > test.json << 'EOF'
{paste your JSON here}
EOF

# Validate
python3 -m json.tool test.json
```

---

### Issue: "Service account authentication failed"

**Check:**
1. Verify JSON is complete
2. Check IAM roles are granted
3. Ensure APIs are enabled

**Quick fix:**
```bash
# Re-run setup script
./setup-vertex-oauth.sh

# Copy new JSON to Supabase
# Redeploy edge function
```

---

## ğŸ“ Setting Variables in Supabase

### Step-by-Step:

1. **Open Supabase Dashboard:**
   ```
   https://app.supabase.com/project/YOUR_PROJECT_ID
   ```

2. **Navigate to Edge Functions:**
   - Left sidebar â†’ Edge Functions
   - Click on "make-server-f7922768"
   - Go to "Settings" tab

3. **Add Secrets:**
   - Click "Add Secret"
   - Enter variable name (exactly as shown above)
   - Paste value
   - Click "Save"

4. **Repeat for all required variables**

5. **Redeploy function:**
   - The function auto-redeploys when secrets change
   - Or manually redeploy if needed

---

## ğŸ”’ Security Notes

### âœ… Best Practices:

1. **Never commit secrets to git**
   ```bash
   # .gitignore should include:
   *.json
   *-key.json
   .env
   .env.local
   ```

2. **Rotate keys regularly**
   - Every 90 days
   - After team member changes
   - If compromise suspected

3. **Use service account in production**
   - More secure than API keys
   - Better access control
   - Audit logging

4. **Monitor usage**
   ```bash
   # Check service account activity
   gcloud logging read \
       "protoPayload.authenticationInfo.principalEmail=google-hackathon-sa@foundestra.iam.gserviceaccount.com" \
       --limit 50
   ```

---

### âŒ Security Don'ts:

1. âŒ Don't share keys in chat/email
2. âŒ Don't use production keys in development
3. âŒ Don't grant unnecessary IAM roles
4. âŒ Don't commit keys to version control

---

## ğŸ“š References

- **Setup Script:** `./setup-vertex-oauth.sh`
- **IAM Permissions:** `/IAM_PERMISSIONS_GUIDE.md`
- **Full Setup Guide:** `/VERTEX_AI_SERVICE_ACCOUNT_SETUP.md`

---

## âœ… Checklist

Before going live, verify:

- [ ] All required environment variables set in Supabase
- [ ] `GOOGLE_SERVICE_ACCOUNT_KEY` contains valid JSON
- [ ] Project ID matches your Google Cloud project
- [ ] Service account has all required IAM roles
- [ ] Vertex AI API enabled
- [ ] Edge function redeployed
- [ ] Test endpoint returns success
- [ ] Key file deleted from local machine (after copying to Supabase)
- [ ] Keys added to .gitignore

---

**Status: Environment Variables Guide Complete âœ…**

Use `/vertex-config` endpoint to verify your current configuration!
